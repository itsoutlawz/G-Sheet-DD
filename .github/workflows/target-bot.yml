name: "DamDama Target Bot âœ¨"

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */1 * * *'   # Every 1 at HH:00
  workflow_dispatch:
    inputs:
      max_profiles:
        description: 'Max Profiles (0 = unlimited)'
        required: false
        default: '0'
      batch_size:
        description: 'Batch Size'
        required: false
        default: '10'

env:
  PYTHON_VERSION: '3.10'
  MIN_DELAY: '0.5'
  MAX_DELAY: '0.7'
  PAGE_LOAD_TIMEOUT: '30'
  SHEET_WRITE_DELAY: '1.0'

jobs:
  run-bot:
    name: Run Target Bot
    runs-on: ubuntu-latest
    timeout-minutes: 59
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Set up ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run bot
        env:
          DAMADAM_USERNAME: ${{ secrets.DAMADAM_USERNAME }}
          DAMADAM_PASSWORD: ${{ secrets.DAMADAM_PASSWORD }}
          DAMADAM_USERNAME_2: ${{ secrets.DAMADAM_USERNAME_2 || '' }}
          DAMADAM_PASSWORD_2: ${{ secrets.DAMADAM_PASSWORD_2 || '' }}
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          MAX_PROFILES_PER_RUN: ${{ github.event.inputs.max_profiles || '0' }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '10' }}
        run: |
          set -e  # Exit immediately if a command exits with a non-zero status
          
          # Check required environment variables
          for var in DAMADAM_USERNAME DAMADAM_PASSWORD GOOGLE_SHEET_URL GOOGLE_CREDENTIALS_JSON; do
            if [ -z "${!var}" ]; then
              echo "âŒ Error: $var is not set"
              exit 1
            fi
          done
          
          echo "ðŸ”§ Setting up environment..."
          
          # Create and secure credentials file
          echo "$GOOGLE_CREDENTIALS_JSON" > credentials.json
          chmod 600 credentials.json
          
          # Set up environment variables
          export GOOGLE_APPLICATION_CREDENTIALS="$PWD/credentials.json"
          
          echo "ðŸš€ Starting bot with:"
          echo "- Max Profiles: ${MAX_PROFILES:-0}"
          echo "- Batch Size: ${BATCH_SIZE:-10}"
          
          # Run the bot
          python Scraper.py
          

          echo "âœ… Bot completed successfully"

